#:import ViewController ceed.view.controller.ViewController
#:import Factory kivy.factory.Factory

<ControlDisplay@KNSpaceBehavior+ScrollView>
    knsname: 'control_display'
    on_size:
        scaler.transform = Matrix()
        scaler.pos = 0, 0
        float.size = scaler.bbox[1]
        self.scroll_x, self.scroll_y = 0., 1.
    bar_width: '10dp'
    scroll_type: ['bars']
    canvas.before:
        Color:
            rgba: [0, 0, 0, 1]
        Rectangle:
            pos: self.pos
            size: self.size
    FloatLayout:
        id: float
        size_hint: None, None
        Scatter:
            id: scaler
            size_hint: None, None
            size: ViewController.screen_width, ViewController.screen_height
            on_touch_up:
                top = -self.y + (float.height - root.height) * root.scroll_y + root.height
                skip_y = self.y >= 0 or root.height >= float.height

                left = -self.x + (float.width - root.width) * root.scroll_x
                skip_x = self.x >= 0 or root.width >= float.width

                self.parent.size = self.bbox[1]
                self.pos = 0, 0

                if not skip_x: root.scroll_x = left / (float.width - root.width)
                if not skip_y: root.scroll_y = (top - root.height) / (float.height - root.height)
            do_translation: False, False
            do_scale: painter.locked and not painter.select and not painter.move_cam
            do_rotation: False
            Widget:
                BufferImage:
                    knsname: 'central_display'
                    auto_bring_to_front: False
                    size_hint: None, None
                    size: self.image_size
                    scale_to_image: False

                    do_scale: painter.locked and not painter.select and painter.move_cam
                    do_translation: self.do_scale, self.do_scale
                    do_rotation: self.do_scale

                    scale: ViewController.cam_scale
                    x: ViewController.cam_offset_x
                    y: ViewController.cam_offset_y
                    rotation: ViewController.cam_rotation

                    on_x: ViewController.cam_offset_x = self.x
                    on_y: ViewController.cam_offset_y = self.y
                    on_scale: ViewController.cam_scale = self.scale
                    on_rotation: ViewController.cam_rotation = self.rotation
                CeedPainter:
                    knsname: 'painter'
                    id: painter
                    size_hint: None, None
                    size: ViewController.screen_width, ViewController.screen_height
                    move_cam: False

<ControlBar@BoxLayout>:
    size_hint: None, None
    size: self.minimum_width, '34dp'
    padding: '5dp'
    spacing: '5dp'
    FlatSpinner:
        id: stage_spinner
        values: sorted(StageFactory.stage_names.keys()) if StageFactory.stage_names else []
        text_autoupdate: True
        size_hint_x: None
        width: self.minimum_width
        flat_color: app.theme.text_primary
        flat_menu_color: app.theme.accent
        flat_drop_background_color: app.theme.primary_text
        flat_drop_text_color: app.theme.text_primary
        flat_border_color: app.theme.divider
    FlatImageToggleButton:
        source: 'flat_play.png' if self.state == 'normal' else 'flat_stop.png'
        flat_color: app.theme.accent
        on_release: ViewController.request_stage_start(stage_spinner.text) if self.state == 'down' else ViewController.request_stage_end()
        state: 'down' if ViewController.stage_active else 'normal'
        hover_text: '[b]start[/b] stage' if self.state == 'normal' else '[b]stop[/b] stage'
    FlatImageToggleButton:
        on_release: ViewController.start_process() if self.state == 'down' else ViewController.stop_process()
        state: 'down' if ViewController.view_process else 'normal'
        source: 'flat_window_restore.png'
        scale_down_color: True
        flat_color: app.theme.accent
        hover_text: '[b]hide[/b] / show window' if self.state == 'normal' else 'hide / [b]show[/b] window'
    FlatImageToggleButton:
        on_release: ViewController.preview = self.state == 'down'
        state: 'down' if ViewController.preview else 'normal'
        source: 'flat_snowflake.png'
        scale_down_color: True
        flat_color: app.theme.accent
        hover_text: 'preview' if self.state == 'normal' else '[b]preview[/b]'
    FlatImageToggleButton:
        source: 'flat_fullscreen.png' if self.state == 'normal' else 'flat_fullscreen_exit.png'
        flat_color: app.theme.accent
        on_release: ViewController.request_fullscreen(self.state == 'down')
        state: 'down' if ViewController.fullscreen else 'normal'
        hover_text: 'fullscreen' if self.state == 'normal' else '[b]fullscreen[/b]'
    FlatImageButton:
        on_parent: self.stage_graph = Factory.StageGraphPopup()
        on_release: self.stage_graph.open()
        source: 'flat_chart_line.png'
        scale_down_color: True
        flat_color: app.theme.accent
        hover_text: 'show stage timeline'
    FlatLabel:
        flat_color: app.theme.text_primary
        text: '{:^ 3} / {:^ 3}'.format(int(round(ViewController.cpu_fps)), int(round(ViewController.gpu_fps)))
        size_hint_x: None
        padding_x: '5dp'
        width: self.texture_size[0]
    FlatImageButton:
        on_parent: self.more_widget = Factory.ViewConfig()
        scale_down_color: True
        source: 'flat_dots_vertical.png'
        flat_color: app.theme.accent
        on_release: self.more_widget.open(root)


<ViewConfig@FlatDropDown>:
    flat_color: app.theme.primary_text
    flat_border_color: app.theme.divider
    do_scroll: False, False
    FlatSplitter:
        size_hint: None, None
        height: self.minimum_height
        min_size: self.minimum_width
        sizable_from: 'right'
        flat_color: app.theme.accent
        GridLayout:
            orientation: 'vertical'
            size_hint_y: None
            height: self.minimum_height
            size_hint_min_x: self.minimum_width
            padding: '5dp'
            spacing: '5dp'
            cols: 2
            FlatLabel:
                size_hint: None, None
                size: self.texture_size
                text: 'Video mode'
                flat_color: app.theme.text_primary
            FlatSpinner:
                disabled: not ViewController.propixx_lib
                values: ViewController.video_modes
                text: 'RGB'
                on_text: ViewController.set_video_mode(self.text)
                size_hint_x: None
                width: self.minimum_width
                flat_color: app.theme.text_primary
                flat_menu_color: app.theme.accent
                flat_drop_background_color: app.theme.primary_text
                flat_drop_text_color: app.theme.text_primary
                flat_border_color: app.theme.divider
            FlatLabel:
                size_hint: None, None
                size: self.texture_size
                text: 'LED mode (ON)'
                flat_color: app.theme.text_primary
            FlatSpinner:
                disabled: not ViewController.propixx_lib
                values: ViewController.led_modes.keys()
                text: 'RGB'
                on_text: ViewController.set_led_mode(self.text)
                size_hint_x: None
                width: self.minimum_width
                flat_color: app.theme.text_primary
                flat_menu_color: app.theme.accent
                flat_drop_background_color: app.theme.primary_text
                flat_drop_text_color: app.theme.text_primary
                flat_border_color: app.theme.divider
