#:import knspace kivy.uix.behaviors.knspace.knspace
#:import FunctionFactory ceed.function.FunctionFactory
#:import get_color_from_hex kivy.utils.get_color_from_hex
#:import StageFactory ceed.stage.StageFactory
#:import StageFactory ceed.view.controller.StageFactory


<PaintBar@BoxLayout>:
    spacing: '9dp'
    size_hint: None, None
    size: self.minimum_width, '35dp'
    ToggleButton:
        group: 'paint'
        text: 'Circle'
        size_hint_x: None
        padding_x: '5dp'
        width: self.texture_size[0]
        on_state: knspace.painter.draw_mode = 'circle' if self.state == 'down' else 'none'
    ToggleButton:
        group: 'paint'
        text: 'Ellipse'
        size_hint_x: None
        padding_x: '5dp'
        width: self.texture_size[0]
        on_state: knspace.painter.draw_mode = 'ellipse' if self.state == 'down' else 'none'
    ToggleButton:
        group: 'paint'
        text: 'Free'
        size_hint_x: None
        padding_x: '5dp'
        width: self.texture_size[0]
        state: 'down'
        on_state: knspace.painter.draw_mode = 'freeform' if self.state == 'down' else 'none'
    ToggleButton:
        group: 'paint'
        text: 'Poly'
        size_hint_x: None
        padding_x: '5dp'
        width: self.texture_size[0]
        on_state: knspace.painter.draw_mode = 'polygon' if self.state == 'down' else 'none'
    ToggleButton:
        group: 'paint'
        text: 'Bezier'
        size_hint_x: None
        padding_x: '5dp'
        width: self.texture_size[0]
        on_state: knspace.painter.draw_mode = 'bezier' if self.state == 'down' else 'none'
    ToggleButton:
        id: select
        text: 'Select'
        size_hint_x: None
        padding_x: '5dp'
        width: self.texture_size[0]
        on_state:
            knspace.painter.select = self.state == 'down'
            if self.state == 'down': move_cam.state = 'normal'
    ToggleButton:
        id: lock
        text: 'Lock'
        size_hint_x: None
        padding_x: '5dp'
        width: self.texture_size[0]
        on_state:
            knspace.painter.locked = self.state == 'down'
            if self.state == 'normal': move_cam.state = 'normal'
    ToggleButton:
        text: 'Add'
        size_hint_x: None
        padding_x: '5dp'
        width: self.texture_size[0]
        on_state:
            knspace.shape_groups.touch_multiselect = knspace.shapes.touch_multiselect = knspace.painter.multiselect = self.state == 'down'
    Button:
        text: 'Copy'
        size_hint_x: None
        padding_x: '5dp'
        width: self.texture_size[0]
        disabled: lock.state == 'down'
        on_release: knspace.painter.duplicate_selected_shapes()
    ImageButton:
        size_hint_x: None
        width: self.height
        source: 'delete.png' if self.state == 'normal' else 'delete_down.png'
        disabled: lock.state == 'down'
        on_release: knspace.painter.delete_shapes()
    ToggleButton:
        text: 'Show'
        size_hint_x: None
        padding_x: '5dp'
        width: self.texture_size[0]
        on_state: knspace.painter.show_label = self.state == 'down'
    ToggleButton:
        text: 'Cam'
        id: move_cam
        size_hint_x: None
        padding_x: '5dp'
        width: self.texture_size[0]
        on_state:
            if self.state == 'down': lock.state = 'down'
            if self.state == 'down': select.state = 'normal'
            knspace.painter.move_cam = self.state == 'down'


<ShapeListing@Splitter>:
    size_hint_x: None
    width: '150dp'
    sizable_from: 'left'
    strip_size: '5dp'
    min_size: '15dp'
    max_size: '400dp'
    BoxLayout:
        orientation: 'vertical'
        BoxLayout:
            orientation: 'vertical'
            size_hint_y: None
            height: self.minimum_height
            ScrollView:
                bar_width: '10dp'
                scroll_type: ['bars']
                size_hint_y: None
                height: control_box.minimum_height
                BoxLayout:
                    id: control_box
                    orientation: 'horizontal'
                    size_hint_y: None
                    height: self.minimum_height
                    size_hint_min_x: self.minimum_width
                    Button:
                        text: '+Selection'
                        size_hint: None, None
                        size: self.texture_size
                        padding: '10dp', '5dp'
                        on_release: shape_groups.add_selected_shapes()
                    Button:
                        text: '+Group'
                        size_hint: None, None
                        size: self.texture_size
                        padding: '10dp', '5dp'
                        on_release: knspace.painter.add_group()
            Splitter:
                size_hint_min_x: self.minimum_width
                sizable_from: 'bottom'
                strip_size: '5dp'
                size_hint_y: None
                min_size: 0
                max_size: root.height
                height: '50dp'
                ScrollView:
                    bar_width: '10dp'
                    scroll_type: ['bars']
                    ShapeGroupList:
                        id: shape_groups
                        knsname: 'shape_groups'
                        orientation: 'vertical'
                        spacing: '3dp'
                        size_hint_y: None
                        height: self.minimum_height
                        size_hint_min_x: self.minimum_width
                        multiselect: True
                        nodes_order_reversed: False
                        touch_deselect_last: True
        ScrollView:
            bar_width: '10dp'
            scroll_type: ['bars']
            ShapeList:
                id: shapes
                knsname: 'shapes'
                orientation: 'vertical'
                spacing: '3dp'
                size_hint_y: None
                height: self.minimum_height
                size_hint_min_x: self.minimum_width
                multiselect: True
                touch_deselect_last: True


<WidgetShape>:
    size_hint_y: None
    height: self.minimum_height
    size_hint_min_x: self.minimum_width
    orientation: 'vertical'
    more: more.__self__
    show_more: expand.is_open
    spacing: '5dp'
    padding: '5dp'
    BoxSelector:
        size_hint_y: None
        height: self.minimum_height
        size_hint_min_x: self.minimum_width
        orientation: 'horizontal'
        controller: knspace.shapes
        ExpandWidget:
            id: expand
        Label:
            text: root.shape.name if root.shape else ''
            size_hint_y: None
            padding: '10dp', '5dp'
            height: self.texture_size[1]
            size_hint_min_x: self.texture_size[0]
        ImageButton:
            size_hint_x: None
            width: self.height
            source: 'delete.png' if self.state == 'normal' else 'delete_down.png'
            on_release: knspace.painter.remove_shape(root.shape)
        ImageToggleButton:
            size_hint_x: None
            width: self.height
            source: 'lock.png' if self.state == 'normal' else 'lock_down.png'
            state: 'down' if root.shape and root.shape.locked else 'normal'
            on_state: root.painter.lock_shape(root.shape) if self.state == 'down' else root.painter.unlock_shape(root.shape)
    BoxLayout:
        id: more
        size_hint_y: None
        height: self.minimum_height
        size_hint_min_x: self.minimum_width
        orientation: 'vertical'
        spacing: '5dp'
        padding: '5dp'
        TextInput:
            size_hint_y: None
            height: self.minimum_height
            multiline: False
            text: root.shape.name if root.shape else ''
            on_focus: if not self.focus: self.text = root.painter._change_shape_name(root.shape, self.text)
        BoxLayout:
            size_hint_y: None
            height: x.minimum_height
            TextInput:
                id: x
                multiline: False
                input_filter: 'int'
                text: str(int(root.centroid_x))
                on_focus: if not self.focus: root._update_centroid(x=int(x.text))
            TextInput:
                id: y
                multiline: False
                input_filter: 'int'
                text: str(int(root.centroid_y))
                on_focus: if not self.focus: root._update_centroid(y=int(y.text))


<WidgetShapeGroup>:
    size_hint_y: None
    height: self.minimum_height
    size_hint_min_x: self.minimum_width
    orientation: 'vertical'
    more: more.__self__
    show_more: expand.is_open
    spacing: '5dp'
    padding: '5dp'
    BoxSelector:
        size_hint_y: None
        height: self.minimum_height
        size_hint_min_x: self.minimum_width
        orientation: 'horizontal'
        controller: knspace.shape_groups
        ExpandWidget:
            id: expand
        Label:
            text: root.group.name if root.group else ''
            size_hint_y: None
            padding: '10dp', '5dp'
            height: self.texture_size[1]
            size_hint_min_x: self.texture_size[0]
        ImageButton:
            size_hint_x: None
            width: self.height
            source: 'delete.png' if self.state == 'normal' else 'delete_down.png'
            on_release: knspace.painter.remove_group(root.group)
    BoxLayout:
        id: more
        size_hint_y: None
        height: self.minimum_height
        size_hint_min_x: self.minimum_width
        orientation: 'vertical'
        TextInput:
            size_hint_y: None
            height: self.minimum_height
            multiline: False
            text: root.group.name if root.group else ''
            on_focus: if not self.focus: self.text = knspace.painter._change_shape_name(root.group, self.text)


<ShapeGroupItem>:
    size_hint_y: None
    height: self.minimum_height
    size_hint_min_x: self.minimum_width
    orientation: 'horizontal'
    controller: knspace.shape_groups
    use_parent: False
    spacing: '5dp'
    padding: '5dp'
    Label:
        text: root.shape.name if root.shape is not None else ''
        size_hint_y: None
        padding: '10dp', '5dp'
        height: self.texture_size[1]
        size_hint_min_x: self.texture_size[0]
    ImageButton:
        size_hint_x: None
        width: self.height
        source: 'delete.png' if self.state == 'normal' else 'delete_down.png'
        on_release: root.group.group.remove_shape(root.shape)
